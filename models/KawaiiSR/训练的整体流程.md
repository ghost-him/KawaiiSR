
### 进阶版三阶段训练策略

---

#### **第一阶段：基础能力训练 (Foundational Training)**

*   **目标**: 让整个网络（HAT + 残差块）学会核心的超分辨率能力。
*   **设置**:
    *   **输入图片**: 128x128 的图像块 (Patches)。
    *   `use_tiling`: `False`。
*   **训练细节**:
    *   **学习率**: 相对较高的初始学习率，例如 `1e-4`，并使用学习率衰减策略（如 Cosine Annealing）。
    *   **训练对象**: 训练模型的**所有参数** (`hat_model` 和 `residual_block` 都在学习)。
    *   **持续时间**: 这是最主要的训练阶段，直到验证集上的指标（PSNR/SSIM）不再显著提升为止。
*   **阶段成果**: 得到一个在 128x128 尺寸上表现优异的 SR 模型。此时模型处理大图（开启分块）可能会产生可见的伪影。

---

#### **第二阶段：分块适应性训练 (Tiling Adaptation)**

*   **目标**: 让模型适应分块推理的工作模式，开始初步处理伪影。
*   **设置**:
    *   **输入图片**: **仍然使用 128x128 的图像块**。这样做是为了隔离变量，让模型只专注于“分块”这个新问题，而不是同时处理“分块”和“大尺寸上下文”两个问题。
    *   `use_tiling`: `True`。
    *   `tile_size`: `64`
    *   `tile_pad`: `32`
*   **训练细节**:
    *   **学习率**: 加载第一阶段的模型权重，并使用一个**较低的学习率**，例如 `2e-5`。
    *   **训练对象**: 仍然训练模型的**所有参数**。在这个阶段，HAT 和残差块需要共同协作，调整自己以适应分块输入/输出的模式。
    *   **持续时间**: 这个阶段相对较短，主要是微调，当验证指标稳定即可。
*   **阶段成果**: 模型现在能够更好地处理分块，伪影会比第一阶段结束时少，但可能依然存在，尤其是在纹理复杂的区域。

---

#### **第三阶段：伪影消除专项微调 (Artifact Removal Fine-tuning)**

*   **目标**: **专门训练残差块**，使其成为一个高效的分块伪影“橡皮擦”。
*   **设置**:
    *   **输入图片**: 使用更大、尺寸更多样的图片，例如 256x256, 384x384, 512x512 等。这能让模型见到真实世界中更复杂的伪影模式。
    *   `use_tiling`: `True`。
*   **训练细节**:
    *   **学习率**: 加载第二阶段的模型权重，使用一个**非常低的学习率**，例如 `1e-5` 或 `5e-6`。
    *   **训练对象**: **冻结 `hat_model` 的所有参数，只训练 `residual_block` 和 `out_conv` 的参数。**
        ```python
        # 伪代码
        for param in model.hat_model.parameters():
            param.requires_grad = False
        
        for param in model.residual_block.parameters():
            param.requires_grad = True

        for param in model.out_conv.parameters():
            param.requires_grad = True
        
        optimizer = torch.optim.Adam([
            {'params': model.residual_block.parameters()},
            {'params': model.out_conv.parameters()}
        ], lr=1e-5)
        ```
    *   **为什么这么做？**
        1.  HAT 经过前两个阶段的训练，已经是一个非常强大的特征提取器和 SR 核心了，我们不希望在处理伪影时破坏它学到的宝贵知识。
        2.  通过冻结 HAT，损失函数的梯度将完全集中在残差块上。这相当于告诉残差块：“HAT 的输出就这样了，你的唯一任务就是修复它留下的所有瑕疵（主要是伪影）。” 这会极大地强化它消除伪影的能力。
*   **阶段成果**: 得到最终模型。它既拥有 HAT 强大的 SR 性能，又具备残差块出色的伪影消除能力，从而可以稳健地处理各种尺寸的高分辨率图像。
