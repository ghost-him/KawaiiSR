训练时的思考：

刚刚看到了一个论文：[CVPR 2024 APISR](https://github.com/Kiteretsu77/APISR/)，这个论文提出了一个非常有意思的训练方式：在图像超分辨率时，通过增加图像的线条，从而使得模型可以学到更清晰的线条。这个或许我也可以添加到我的模型中。

目前的考虑是前80%的训练轮数使用交替的方式，训练锐化后的图片与原图像的图片。而后20%的训练则只专心于原图像的训练。但是具体的效果还得在训练的时候看

或许可以在一个预训练的模型上做微调，像伪影判别器一样，分别两个阶段。

同时，也可以先使用isdir数据集（一共有84,991个高质量的图片）与DIV2K数据集（1000个图片）预处理一个超分辨率网络，然后再使用我的动漫图像做细节上的的微调。

设为9w个图片，如果每个图片使用3个下采样算法，这样就是9 * 3 = 27w个数据对了。效果应该会很不错。


目前发现 https://github.com/XPixelGroup/HAT 这个模型还不错，打算就用这个模型当做基础的模型，然后再加一些我自己的想法，当成超分辨率模型了

根据HAT这个论文，模型在训练时要选择`128*128`大小的输入，来生成`256*256`的图片，所以在制作数据集时，将切片设置为`256*256`就足够了

#### 总体损失函数

\[ L_{\text{total}} = \lambda_{\text{pix}} L_{\text{pix}} + \lambda_{\text{perc}} L_{\text{perc}} + \lambda_{\text{adv}} L_{\text{adv}} + \lambda_{\text{freq}} L_{\text{freq}} + \lambda_{\text{artifact}} L_{\text{artifact}} \]

#### 各组件详解

1.  **\(L_{\text{pix}}\) (像素损失)**：**Charbonnier Loss**。
    *   作用：保持基础内容还原的准确性和稳定性。

2.  **\(L_{\text{perc}}\) (感知损失)**：基于 **VGG-19** 的标准感知损失。
    *   作用：保证生成图像在通用视觉特征（纹理、结构）上与真值图像相似，提升整体视觉质量。

3.  **\(L_{\text{adv}}\) (对抗损失)**：**RaGAN** + **多尺度判别器**。
    *   作用：学习真实动漫图像的整体数据分布，生成看起来“自然”和“真实”的图像，增强细节。

4.  **\(L_{\text{freq}}\) (频率损失)**：基于**拉普拉斯算子**的高频误差损失。
    *   作用：专门针对动漫线条，强制模型生成更锐利、清晰的边缘。

5.  **\(L_{\text{artifact}}\) (伪影损失)**：**使用您自定义的伪影检测模型**（推荐方法A）。
    *   作用：**核心优势所在**。精准地惩罚生成图像中可能出现的各种伪影（色块、振铃、模糊等），引导模型生成更干净、更高质量的图像。

#### 训练中使用的损失函数策略

两阶段训练策略依然适用且强烈推荐：

*   **第一阶段（预训练）**：仅使用 \(L_{\text{pix}}\) 进行训练，建立模型的基础重建能力。
*   **第二阶段（精调）**：载入预训练模型，使用完整的 \(L_{\text{total}}\) 进行端到端的精细化训练。


#### 四、 最终总结与超参数建议

| 损失组件 | 推荐形式 | 核心作用 | 建议起始权重 (\(\lambda\)) |
| :--- | :--- | :--- | :--- |
| **\(L_{\text{pix}}\)** | Charbonnier Loss | 稳定基础重建，保证内容准确性 | 1.0 (作为基准) |
| **\(L_{\text{perc}}\)** | 混合感知 (VGG + AnimeNet) | 融合通用与动漫风格，抑制伪影 | 0.5 - 1.0 |
| **\(L_{\text{adv}}\)** | RaGAN + Multi-Scale D | 提升视觉真实感和细节纹理 | 0.1 - 0.2 |
| **\(L_{\text{freq}}\)** | 拉普拉斯高频误差 | 锐化线条，增强边缘清晰度 | 0.2 - 0.5 |
| **\(L_{\text{art\_cls}}\)** | **交叉熵损失** | **(新增) 全局惩罚，抑制被检测到的伪影** | **0.05 - 0.2** |
| **\(L_{\text{art\_feat}}\)** | **特征L1距离** | **(新增) 细粒度监督，学习无伪影特征分布** | **0.5 - 1.5** |