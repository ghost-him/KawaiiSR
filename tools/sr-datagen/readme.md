> 以下的内容由 gemini 2.5 pro 生成

# 超分辨率数据集生成器 (Super-Resolution Dataset Generator)

一个强大、灵活且高效的命令行工具，使用 Rust 编写，专为创建深度学习超分辨率（Super-Resolution）模型所需的数据集而设计。

该工具可以处理多种图像格式，包括矢量图（SVG）和位图（PNG, JPG等），并通过并行处理来最大化利用多核CPU性能，显著加快数据集的生成速度。

## 核心特性

- **支持多种格式**: 可无缝处理矢量图 (SVG) 和主流位图 (PNG, JPEG, BMP, etc.)。
- **高性能并行处理**: 基于 `rayon` 库实现，能够并行处理大量文件，充分利用多核处理器资源。
- **灵活的下采样**: 支持多种下采样算法 (`Nearest`, `Lanczos3`, `CatmullRom` 等)，允许你为模型测试不同的降质方法。
- **数据增强**: 内置简单有效的数据增强功能（水平翻转、90度旋转），轻松扩充数据集规模。
- **JPEG压缩模拟**: 能够对生成的低分辨率（LR）图像应用不同质量的JPEG压缩，以模拟真实世界中的压缩伪影。
- **自动化索引**: 自动为生成的高分辨率（HR）和低分辨率（LR）图像对创建CSV索引文件，方便数据加载。
- **清晰的命名约定**: 生成的文件名包含了处理参数（如缩放比例、下采样算法等），便于追溯和管理。

## 处理流程

工具的处理流程被精心设计以实现高效和可配置的数据集生成。

1.  **配置解析**:
    - 程序启动时，通过 `clap` 解析所有命令行参数，例如输入/输出路径、缩放比例、下采样算法等。
    - 在正式处理前，会打印出完整的配置信息，并请求用户确认（除非使用 `-y` 参数跳过）。

2.  **环境初始化**:
    - 在指定的输出目录下，创建用于存放高分辨率图像的 `HR` 目录和低分辨率图像的 `LR` 目录（目录名可自定义）。
    - 创建一个 `dataset_index.csv` 文件，并写入表头 `lr_image_path,hr_image_path`。

3.  **文件扫描**:
    - 使用 `walkdir` 递归扫描指定的输入目录，收集所有文件的路径。

4.  **并行处理**:
    - 将所有找到的文件路径分发给一个并行的迭代器 (`rayon`)。
    - 程序会根据文件扩展名，为每个文件调用相应的处理函数（`process_svg` 或 `process_bitmap`）。
    - 一个原子计数器会实时跟踪处理进度，并以百分比形式打印到控制台。

5.  **图像处理 (按类型)**:
    - **对于SVG文件 (`.svg`)**:
        - 对用户指定的每个渲染尺寸（例如 `128`, `256`），程序会：
        1. 将SVG渲染成指定尺寸的PNG图像，作为 **HR 图像**。
        2. 将SVG渲染成 `尺寸 / 缩放比例` 大小的PNG图像，作为 **LR 图像**。
        - 这种方法可以从单个SVG文件生成多对高质量的HR/LR样本。
    - **对于位图文件 (`.png`, `.jpg`, etc.)**:
        1.  **基础处理**:
            - 原始图像被统一转换为RGBA格式并保存为 **HR 图像** (`{原始名}_hr.png`)。
            - 遍历所有指定的下采样算法，将HR图像缩放到 `1/scale` 大小，生成对应的 **LR 图像** (`{原始名}_{算法}_x{scale}_lr.png`)。
        2.  **JPEG压缩 (可选)**:
            - 如果指定了 `--jpeg-quality`，对于每个下采样生成的LR图像，程序会额外创建其JPEG压缩版本。图像会先在内存中被压缩，然后重新解码并保存为PNG格式，以保留压缩伪影但不引入两重压缩。文件名会包含质量因子 (`_q{质量}_`)。
        3.  **数据增强 (可选)**:
            - 如果启用了 `--augment`，程序会先对原始HR图像进行水平翻转和90度旋转，生成新的HR图像 (`{原始名}_hflip_hr.png`, `{原始名}_rot90_hr.png`)。
            - 然后，对这些增强后的HR图像重复上述的下采样和JPEG压缩流程，生成对应的LR图像。

6.  **索引写入**:
    - 每成功生成一对 `(LR, HR)` 图像，它们的相对路径就会被写入到 `dataset_index.csv` 文件中。这个过程是线程安全的。

7.  **完成**:
    - 所有文件处理完毕后，程序会显示最终的输出路径和索引文件路径，然后退出。

## 安装与编译

1.  确保你已经安装了 [Rust 工具链](https://www.rust-lang.org/tools/install)。
2.  克隆本仓库并进入项目目录。
3.  编译项目以获得最佳性能：
    ```bash
    cargo build --release
    ```
4.  可执行文件将位于 `target/release/` 目录下。

## 使用方法

### 基本命令

```bash
# 格式
./target/release/<your_binary_name> --input-dir <输入文件夹> --output-dir <输出文件夹> [OPTIONS]
```

### 参数详解

-   `-i, --input-dir <PATH>`: **(必需)** 包含源图像（SVG, PNG, JPG等）的文件夹。
-   `-o, --output-dir <PATH>`: **(必需)** 用于存放生成的数据集的文件夹。
-   `--hr-dir-name <NAME>`: HR图像子文件夹的名称 (默认: `HR`)。
-   `--lr-dir-name <NAME>`: LR图像子文件夹的名称 (默认: `LR`)。
-   `-s, --scale <SCALE>`: 超分辨率的缩放比例 (整数, 默认: `2`)。
-   `--svg-sizes <SIZES>`: **[仅SVG]** 以逗号分隔的HR图像渲染尺寸列表 (例如: `"128,256,512"`, 默认: `"128,256,512,1024"`)。
-   `--downsample-filters <FILTERS>`: **[仅位图]** 以逗号分隔的下采样算法列表。
    - 可选项: `Nearest`, `Triangle`, `CatmullRom`, `Gaussian`, `Lanczos3`
    - 默认: `"Nearest,Lanczos3"`
-   `--augment`: **[仅位图]** 启用数据增强（水平翻转和旋转90度）。
-   `--jpeg-quality <QUALITY>`: **[仅位图]** 对LR图像应用JPEG压缩，并指定质量 (1-100)。可以提供逗号分隔的多个值 (例如: `"75,50"`)。
-   `-y, --yes`: 跳过运行前的确认提示。

### 示例

以下是使用示例，将该 readme 所在的目录作为工作目录，输入以下的命令即可开始运行，输出的结果存放在 `test_output` 文件夹中。

```bash
cargo run -- --input-dir ./test_input --output-dir ./test_output --augment --jpeg-quality 80
```